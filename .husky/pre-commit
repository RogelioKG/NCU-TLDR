#!/bin/sh
set -e

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_msg() {
    printf "$1$2${NC}\n"
}

print_msg "$GREEN" "ğŸš€ [Pre-commit] Starting Checks..."

# Check if backend files are changed
if git diff --cached --name-only | grep -q "^backend/"; then
    print_msg "$BLUE" "ğŸ”„ [Backend] Checking..."
    cd backend

    # 1. Lint & Format Check
    uv run ruff check .
    uv run ruff format --check .

    # 2. Check requirements.txt Consistency
    if ! uv export --locked --no-hashes --no-annotate --format requirements.txt | diff -q requirements.txt - > /dev/null 2>&1; then
        print_msg "$RED" "âŒ [Backend] requirements.txt is out of sync!"
        print_msg "$RED" "   -> Fix: cd backend && uv export --locked --no-hashes --no-annotate --format requirements.txt > requirements.txt"
        exit 1
    fi

    cd ..
else
    print_msg "$YELLOW" "â­ï¸  [Backend] No changes detected, skipping..."
fi

# Check if frontend files are changed
if git diff --cached --name-only | grep -q "^frontend/"; then
    print_msg "$BLUE" "ğŸ”„ [Frontend] Checking..."
    cd frontend

    # 1. Lint Check
    pnpm run lint

    cd ..
else
    print_msg "$YELLOW" "â­ï¸  [Frontend] No changes detected, skipping..."
fi

print_msg "$GREEN" "âœ… [Pre-commit] All checks passed! Committing..."
